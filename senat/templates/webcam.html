{% comment %} {% block content %}
    <form method="post" action="{% url 'senat:webcam' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            <h3>Capture Image From Webcam</h3>
            <hr>
            <img id="webcam-preview" src="" style="width: 400px; height: 400px">
            <input type="file" name="image" id="webcam-capture" style="display:none;">
            <button type="button" id="webcam-button" class="btn btn-primary btn-lg">Capture</button>
        </div>
        <button type="submit" class="btn btn-success btn-lg">Save to database</button>
    </form>

    <script>
        var video = document.createElement('video');
        var canvas = document.createElement('canvas');
        var constraints = { audio: false, video: { width: 400, height: 300 } };
        navigator.mediaDevices.getUserMedia(constraints)
        .then(function(mediaStream) {
            video.srcObject = mediaStream;
            video.play();
        });

        document.getElementById('webcam-button').onclick = function() {
            var context = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;
            context.drawImage(video,0,0,canvas.width,canvas.height);
            var data = canvas.toDataURL('image/png');
            document.getElementById('webcam-capture').files = [dataURLtoFile(data, 'webcam.png')];
            document.getElementById('webcam-preview').src = data;
        }

        function dataURLtoFile(dataurl, filename) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, {type:mime});
        }
    </script>
{% endblock %} {% endcomment %}









{% comment %} {% block content %}

<h1 class="my-4">Webcam Capture</h1>
<hr>

<button type="button" id="webcamButton" class="btn btn-primary btn-lg">Capture Image</button>

<canvas id="canvas" style="display:none;"></canvas>

<script type="text/javascript">

// Get media stream from webcam
navigator.mediaDevices.getUserMedia({ video: true, audio: false })
  .then(function(stream) {
    var video = document.createElement('video');
    var canvas = document.getElementById('canvas');
    var button = document.getElementById('webcamButton');

    video.srcObject = stream;
    video.play();

    // Take a still image from the live video stream
    button.onclick = function() {
      var context = canvas.getContext('2d');
      canvas.width = video.offsetWidth;
      canvas.height = video.offsetHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Convert canvas data to image data URL
      var dataURL = canvas.toDataURL('image/png');

      // Set captured image data to hidden input field
      document.getElementById('imageData').value = dataURL;

      // Submit form to save image to database
      document.getElementById('webcamForm').submit();
    };
  })
  .catch(function(err) {
    console.log('Error accessing webcam:', err);
  });

</script>

<form id="webcamForm" method="post" action="{% url 'senat:webcam' %}">
  {% csrf_token %}
  <input type="hidden" name="image_data" id="imageData" value="">
  <button type="submit" class="btn btn-success btn-lg" style="display:none;">Save Image</button>
</form>

{% endblock %} {% endcomment %}











<!doctype html>
<html>
  <head>
    <title>Webcam Capture</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <h1>Webcam Capture</h1>
    <div>
      <video id="video-preview" width="640" height="480" autoplay></video>
      <canvas id="canvas-preview" style="display:none;" width="640" height="480"></canvas>
    </div>
    <br>
    <button onclick="capture()">Capture</button>
    <br>
    <div id="capture-img-div"></div>
    <script type="text/javascript">
      var video = document.getElementById('video-preview');
      navigator.mediaDevices.getUserMedia({video: true})
        .then(stream => video.srcObject = stream)
        .catch(error => console.log(error));

      function capture() {
        var imgcanvas = document.getElementById('canvas-preview');
        var imgctx = imgcanvas.getContext('2d');
        imgctx.drawImage(video, 0, 0, 640, 480);
        var imgdata = imgcanvas.toDataURL('image/jpeg');
        // Remove title and section headers from data URL
        var imgstr = imgdata.replace(/^data:image\/(png|jpeg);base64,/, '');
        // Call Django view to save image
        $.ajax({
            
          url: '/save_image/',
          method: 'POST',
          data: {
            'image': imgstr
          },
          success: function(data) {
            if (data.success) {
              // Show captured image
              $('#capture-img-div').html('<img src="' + imgdata + '">');
            } else {
              console.log('Save image failed');
            }
          },
          error: function(jqXHR, textStatus, errorThrown) {
            console.log(textStatus + ': ' + errorThrown);
          }
        });
      }
    </script>
  </body>
</html>